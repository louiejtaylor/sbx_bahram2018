---
title: "Bahram *et al* 2018: Soil bacterial diversity"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = "hide",
                      dev = "svg")
library(dplyr)
library(magrittr)
library(ggplot2)
library(viridis)
library(stringr)
library(vegan)
library(MASS)

taxa_ranks <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")

theme_scatterplot = theme_classic(base_size = 14) + theme(
  line = element_line(size=0.8),
  text = element_text(color = "black"),
  axis.text.x = element_text(color="black"),
  axis.text.y = element_text(color="black")
)

# Make sure Snakemake handles accessible
stopifnot(exists("snakemake"))
```

## Background

This report uses the [Sunbeam pipeline](https://github.com/sunbeam-labs/sunbeam) to reproduce findings from "Structure and function of the global topsoil microbiome" [(PMID: 30069051)](https://www.ncbi.nlm.nih.gov/pubmed/30069051) by Bahram *et al*. A key finding of this paper is that bacterial diversity is highest in temperate habitats, but lower in extreme latitudes and near the equator. This extension tests whether we can reproduce this finding using Sunbeam and Kraken. 

This report was generated by the extension [sbx_bahram2018](https://github.com/louiejtaylor/sbx_bahram2018); this link also includes instructions for re-running this analysis from the beginning.

```{r paths}

metadata_file <- file.path(snakemake@params[['metadata_file']])
kraken_file <- file.path(snakemake@input[['kraken']])

```

```{r metadata-and-classification}

md = read.table(metadata_file, sep = ",", header = TRUE)
kraken <- read.table(kraken_file, header = TRUE, skip = 1, sep = '\t', comment.char = '~')

```
## Results

Using the Kraken output of Sunbeam (rarefied as in Bahram *et al*), we plot inverse Simpson diversity by absolute latitude calculated using the `vegan` package in R. Points are colored by habitat. 

### Kraken results
```{r kraken-plots, fig.width=7, fig.height=4}

# format data
kraken_otus <- kraken$X.OTU.ID
test_kraken <- kraken %$%
  dplyr::select(., -c("Consensus.Lineage", "ERR1877930.taxa")) %$% # no classified reads for ERR1877930
  as.data.frame(t(.[,-1]))

# rareify using rrarefy
rarefied <- vegan::rrarefy(x = test_kraken, sample = 2000)

# calculate inverse Simpson diversity
simpson_div <- as.data.frame(vegan::diversity(rarefied, index = "invsimpson"))
simpson_samples = row.names(simpson_div)
colnames(simpson_div) <- c("simpson")
simpson_div <- dplyr::mutate(simpson_div, Run = gsub(".taxa", "", simpson_samples, fixed = TRUE)) 

# add metadata
md_data <- md %$% 
  dplyr::mutate(., abs_latitude = abs(Latitude)) %$%
  inner_join(., simpson_div, by = "Run") 

# model
m <- lm(data = md_data, formula = simpson ~ poly(Latitude, 2, raw=TRUE))
m_summary <- summary(m)

# re-order factors
md_data$Habitat <- factor(md_data$Habitat, levels = c("Moist_tropical_forests","Tropical_montane_forests","Savannas","Dry_tropical_forests","Temperate_coniferous_forests","Grasslands_and_shrublands","Southern_temperate_forests","Temperate_deciduous_forests","Mediterrean","Boreal_forests","Arctic_tundra"))

environment_colors <- c("#40388f","#4b75b5","#32b9ea","#7fcac9","#f8ed46","#f8c0b0","#f49245","#f17e33","#ec5230","#c0232a","#7d101b")

# plot
ggplot(data = md_data, aes(x = abs_latitude, y = simpson, color = Habitat))+
  geom_point(size=3, alpha = .6) + 
  stat_smooth(method="lm", se=FALSE, formula = y ~ poly(x, 2, raw=TRUE), color="black", size = 1.3) +
  scale_color_manual(labels = c("Moist tropical forests","Tropical montane forests","Savannahs","Dry tropical forests","Temperate coniferous forests","Grasslands and shrublands","Southern temperate forests","Temperate deciduous forests","Mediterranean","Boreal forests","Arctic tundra"), values = environment_colors) +
  theme_scatterplot + labs(x = "Absolute latitude (degrees)", y ="Taxononomic diversity")
```


## Conclusion

The results of our analysis are comparable to those reported by Bahram *et al*. The polynomial regression p-value (p=`r format(pf(q = m_summary$fstatistic["value"], df1=m_summary$fstatistic["numdf"], df2=m_summary$fstatistic["dendf"], lower.tail = FALSE))`) and adjusted r-squared (r^2^=`r format(m_summary$r.squared)`) for the relationship between inverse Simpson diversity and absolute latitude are comparable to the values reported in the manuscript (p=1e-07; r^2^=.160).
